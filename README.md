![Pipeline status](https://gitlab.com/dvalchev/aws-commands/badges/master/pipeline.svg?job=test:8)
![Coverage](https://gitlab.com/dvalchev/aws-commands/badges/master/coverage.svg?job=test:8)

# Какво е това?

Всеки от нас знае колко досадно е когато трябва да се свърже към сървъри в AWS, които често променят своите IP-та. За да го направим ни се налага да отваряме в браузър AWS management console, да се навигираме в конзолата и да търсим текущите IP-тата на сървърите, както и да съставяме всеки път команда за свързване. Целта на проекта е да предостави команди, които да спестят време при изпълнение на подобни повтаряеми задачи по време на работата ни с AWS.

# Как работи?

Командите използват конфигурираните профили на aws-cli (намиращи се в `~/.aws/credentials`, [виж още](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-profiles.html)) за достъп до програмния интерфейс на AWS.

Целта на командите е да минимизират броя на входните данни, които се изискват от потребителя за да се изпълни задача. Ето защо, след първоначално избиране на входни данни за определена команда, при последващо изпълнение на командата, стъпките, които е възможно да бъдат пропуснати, използват вече подадените входни данни от предишно изпълнената команда, освен ако друго поведение не е изрично указано.

# Изисквания

- [ ] PHP >= 7.4
- [ ] Конфигурирани профили на aws-cli (`~/.aws/credentials`). [Виж още](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-profiles.html)

# Инсталиране

```
git clone git@gitlab.com:dvalchev/aws-commands.git
cd aws-commands
make install
```

# Конфигуриране

Командите могат да получават аргументи, които се намират в текущата работна директория или нейните родителските директории от файлове, именувани `.aws-commands` по подразбиране. Това позволява да зададете константни аргументи за папките на даден проект. Например при поставяне на конфигурационен файл в проект altrix командите ще използват винаги AWS профил altrix и съответния SSH ключ и потребител, освен ако не е изрично указано друго.   

Променливи за конфигурация:
| Име | Описание |
| --- | --- |
| `AWS_PROFILE` | Име на профил от aws-cli конфигурацията `~/.aws/credentials`. |
| `SSH_USER` | Име на потребител, който да бъде използван за SSH свързване. |
| `SSH_KEY` | Aбсолютен път към ssh ключ, който да бъде използван при свързване. |

Примерен конфигурационен файл, напр. `~/Dev/altrix/.aws-commands`
```
AWS_PROFILE=altrix
SSH_KEY=/Users/me/.ssh/altrix.id_rsa
SSH_USER=ec2-user
```

Настройка на средата (.env файл):  
*За да промените настройките на средата можете да копирате .env файла като .env.local, където да въведете необходимите промени*

Променливи:
| Име | Описание |
| --- | --- |
| `PERSISTENCE_FILENAME` | Път до файл за съхранение на данни. |
| `INPUT_FILENAME` | Име на файла за конфигурация на аргументи. |
| `AWSDBT_DEFAULT_TUNNEL_PORT` | Порт по подразбиране на локалната машина за тунел към RDS. |
| `EC2_DEFAULT_USER` | Име на потребител по подразбиране при свързване с SSH. |
| `SSH_KEYS_DIRECTORY` | Директория, в която се намират SSH ключовете по подразбиране. |
| `AWS_PROFILE_CREDENTIALS_PATH` | Път до файл с авторизационни данни на aws-cli. |
| `AWS_PROFILE_CONFIGURATION_PATH` | Път до файл с конфигурация за профили на aws-cli. |

Примерна конфигурация:
```
PERSISTENCE_FILENAME=./data/persistence.json
INPUT_FILENAME=.aws-commands
AWSDBT_DEFAULT_TUNNEL_PORT=5434
EC2_DEFAULT_USER=ec2-user
SSH_KEYS_DIRECTORY=~/.ssh
AWS_PROFILE_CREDENTIALS_PATH=~/.aws/credentials
AWS_PROFILE_CONFIGURATION_PATH=~/.aws/config
```

# Команди

## AwSSH

Командата позволява бързо свързване към EC2 инстанция чрез SSH.

```
awssh [options] [--] [<AWS profile> [<SSH user> [<SSH key>]]]
```

Аргументи:
| Име | Описание |
| --- | --- |
| `AWS profile` | Име на профил от aws-cli конфигурацията `~/.aws/credentials`. Може да бъде зададено чрез `AWS_PROFILE` в конфигурационен файл. Ако не бъде подадено, използва посоченото в конфигурационния файл. Ако няма конфигурационен файл, използва последно избрания aws профил. Ако няма такъв се показва стъпка за избор на AWS профил. |
| `SSH user` | Име на потребител, който да бъде използван за SSH свързване (*ec2-user по подразбиране*). Mоже да бъде зададен чрез `SSH_USER` в конфигурационен файл. |
| `SSH key` | Aбсолютен път към ssh ключ, който да бъде използван при свързване. Може да бъде зададен чрез `SSH_KEY` в конфигурационен файл. |

Опции:
| Име | Описание |
| --- | --- |
| `-p, --select-aws-profile` | Игнорира неявното подаване на аргументи и показва стъпката за въвеждане на AWS профил. |
| `--select-ssh-user` | Игнорира неявното подаване на аргументи и показва стъпката за въвеждане на SSH потребител. |
| `--select-ssh-key` | Игнорира неявното подаване на аргументи и показва стъпката за въвеждане на SSH ключ. |
| `-s, --skip-file-input` | Игнорира аргументите подадени чрез конфигурационен файл. |


## AwsDBT

Командата отваря SSH тунел от EC2 инстанция към инстация от RDS. Имената на RDS инстанциите се определят от таг с име `Name`.

```
awsdbt [options] [--] [<AWS profile> [<SSH user> [<SSH key>]]]
```

Аргументи:
| Име | Описание |
| --- | --- |
| `AWS profile` | Име на профил от aws-cli конфигурацията `~/.aws/credentials`. Може да бъде зададено чрез `AWS_PROFILE` в конфигурационен файл. Ако не бъде подадено, използва посоченото в конфигурационния файл. Ако няма конфигурационен файл, използва последно избрания AWS профил. Ако няма такъв се показва стъпка за избор на AWS профил. |
| `SSH user` | Име на потребител, който да бъде използван за SSH свързване (*ec2-user по подразбиране*). Mоже да бъде зададен чрез `SSH_USER` в конфигурационен файл. |
| `SSH key` | Aбсолютен път към ssh ключ, който да бъде използван при свързване. Може да бъде зададен чрез `SSH_KEY` в конфигурационен файл. |

Опции:
| Име | Описание |
| --- | --- | 
| `-p, --select-aws-profile` | Игнорира неявното подаване на аргументи и показва стъпката за въвеждане на AWS профил. |
| `--select-ssh-user` | Игнорира неявното подаване на аргументи и показва стъпката за въвеждане на SSH потребител. |
| `--select-ssh-key` | Игнорира неявното подаване на аргументи и показва стъпката за въвеждане на SSH ключ. |
| `-s, --skip-file-input` | Игнорира аргументите подадени чрез конфигурационен файл. |
| `--port[=PORT]` | Порта, на който ще бъде отворен тунел на локалната машина (*5434 по подразбиране*). Може да бъде зададен чрез конфигурационен файл или променливи на средата (.env). |
